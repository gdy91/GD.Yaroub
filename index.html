<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام GD.Yaroub</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Almarai&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Almarai', sans-serif; background: linear-gradient(to right, #1d1f2f, #3e206d); color: white; margin: 0; }
    header { background: #111; padding: 1rem; text-align: center; font-size: 2rem; letter-spacing: 2px; box-shadow: 0 0 15px rgba(0,0,0,0.5); position: sticky; top: 0; z-index: 1000; }
    .container { max-width: 900px; margin: 2rem auto; background: #2b2d42; padding: 2rem; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    input, textarea, select { width: 100%; padding: 0.8rem; margin-bottom: 1rem; border: none; border-radius: 6px; font-size: 1rem; background: #fff; color: #000; }
    button { background: #ff4081; color: white; padding: 0.6rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 0.3rem; transition: transform 0.2s ease; }
    button:hover { transform: scale(1.05); background: #f50057; }
    .task { background: #393b54; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; position: relative; }
    .note { background: #202233; padding: 0.6rem; margin-top: 0.5rem; border-left: 4px solid #ff4081; display: flex; justify-content: space-between; align-items: center; }
    .note span { flex: 1; }
    .attachment { margin-top: 0.5rem; display: block; color: #ff79c6; text-decoration: underline; }
    #archiveBtn { position: fixed; left: 20px; top: 20px; z-index: 2000; background: #00adb5; }
    .filters { display: flex; gap: 10px; margin-bottom: 1rem; }
    .stats { text-align: center; font-size: 1rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <header>نظام GD.Yaroub</header>
  <button id="archiveBtn" onclick="toggleArchive()">📁 عرض الأرشيف</button>

  <div class="container" id="login">
    <input id="name" placeholder="الاسم">
    <input id="pass" type="password" placeholder="كلمة السر">
    <button onclick="login()">دخول</button>
  </div>

  <div class="container" id="panel" style="display:none">
    <div id="controls" style="margin-bottom:2rem; display: none;">
      <h3>إضافة مهمة جديدة</h3>
      <input id="title" placeholder="عنوان المهمة">
      <textarea id="desc" placeholder="تفاصيل المهمة"></textarea>
      <select id="status">
        <option>جاري العمل</option>
        <option>تم</option>
        <option>معلق</option>
        <option>متأخر</option>
      </select>
      <button onclick="addTask()">حفظ المهمة</button>
    </div>

    <div class="filters">
      <select id="filterStatus" onchange="loadTasks()">
        <option value="">كل الحالات</option>
        <option>جاري العمل</option>
        <option>تم</option>
        <option>معلق</option>
        <option>متأخر</option>
      </select>
      <input type="text" id="searchInput" placeholder="بحث بعنوان المهمة" oninput="loadTasks()">
    </div>

    <div class="stats">
      <span id="statsText"></span>
    </div>

    <div id="tasks"></div>
    <div id="archive" style="display:none">
      <h3>📁 المهام المنجزة</h3>
      <div id="archiveTasks"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDk6PEIIwQCtNkkeC-W7rqvrmFngTzMH84",
      authDomain: "gd-yaroub.firebaseapp.com",
      projectId: "gd-yaroub",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = "";
    let isAdmin = false;

    function login() {
  console.log('محاولة تسجيل الدخول...');
      const name = document.getElementById('name').value.trim();
      const pass = document.getElementById('pass').value.trim();
      if (!name || !pass) {
    console.log('فشل: الاسم أو كلمة السر فارغة');
    return alert('يرجى إدخال الاسم وكلمة السر');
  }
      isAdmin = pass === '919600';
      if (!isAdmin && pass !== '202200') {
    console.log('كلمة السر غير صحيحة');
    return alert('كلمة السر غير صحيحة');
  }
      currentUser = name;
      console.log('تم تسجيل الدخول بنجاح');
document.getElementById('login').style.display = 'none';
      document.getElementById('panel').style.display = 'block';
      if (isAdmin) document.getElementById('controls').style.display = 'block';
      loadTasks();
    }

    function addTask() {
      const title = document.getElementById('title').value;
      const desc = document.getElementById('desc').value;
      const status = document.getElementById('status').value;
      db.collection('tasks').add({ title, desc, status, created: new Date().toLocaleString(), author: currentUser, notes: [] }).then(loadTasks);
      document.getElementById('title').value = '';
      document.getElementById('desc').value = '';
    }

    function addNote(id, oldText = "") {
      const note = prompt("اكتب ملاحظتك", oldText);
      if (!note) return;
      db.collection('tasks').doc(id).get().then(doc => {
        const data = doc.data();
        const notes = data.notes || [];
        const updated = notes.filter(n => !n.startsWith(currentUser + ":") || n === `${currentUser}: ${oldText}`);
        updated.push(`${currentUser}: ${note}`);
        db.collection('tasks').doc(id).update({ notes: updated }).then(loadTasks);
      });
    }

    function archiveTask(id, task) {
      db.collection('archive').add(task).then(() => db.collection('tasks').doc(id).delete().then(loadTasks));
    }

    function deleteTask(id, fromArchive = false) {
      if (confirm("هل تريد حذف المهمة نهائيًا؟")) {
        const col = fromArchive ? 'archive' : 'tasks';
        db.collection(col).doc(id).delete().then(() => fromArchive ? loadArchive() : loadTasks());
      }
    }

    function toggleArchive() {
      const a = document.getElementById('archive');
      a.style.display = a.style.display === 'none' ? 'block' : 'none';
      if (a.style.display === 'block') loadArchive();
    }

    function loadArchive() {
  const box = document.getElementById('archiveTasks');
  box.innerHTML = '';
  let count = 0;
  db.collection('archive').get().then(snapshot => {
    snapshot.forEach(doc => {
      const t = doc.data();
      count++;
      const div = document.createElement('div');
      div.className = 'task';
      div.innerHTML = `
        <b>${t.title}</b><br>
        <small>${t.author}</small><br>
        <p>${t.desc}</p>
        <p><strong>الحالة:</strong> ${t.status}</p>
        <p><small>${t.created}</small></p>
        ${isAdmin ? `<button onclick='deleteTask("${doc.id}", true)'>🗑️ حذف</button>` : ''}
      `;
      box.appendChild(div);
    });
    const stats = document.getElementById('statsText');
    if (stats) stats.textContent = `📁 ${count} مهمة منجزة في الأرشيف`;
  });
}</b><br>
            <small>${t.author}</small><br>
            <p>${t.desc}</p>
            <p><strong>الحالة:</strong> ${t.status}</p>
            <p><small>${t.created}</small></p>
            ${isAdmin ? `<button onclick='deleteTask("${doc.id}", true)'>🗑️ حذف</button>` : ''}
          `;
          box.appendChild(div);
        });
      });
    }

    function loadTasks() {
      const box = document.getElementById('tasks');
      const filter = document.getElementById('filterStatus').value;
      const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
      box.innerHTML = '';
      let done = 0, notDone = 0;

      db.collection('tasks').get().then(snapshot => {
        snapshot.forEach(doc => {
          const t = doc.data();
          if (filter && t.status !== filter) return;
          if (keyword && !t.title.toLowerCase().includes(keyword)) return;

          if (t.status === 'تم') done++; else notDone++;

          const div = document.createElement('div');
          div.className = 'task';
          div.innerHTML = `
            <b>${t.title}</b><br>
            <small>${t.author} ${isAdmin ? '👑' : ''}</small><br>
            <p>${t.desc}</p>
            <p><strong>الحالة:</strong> ${t.status}</p>
            <p><small>${t.created}</small></p>
            ${(t.notes || []).map(note => {
              const [user, ...rest] = note.split(": ");
              const content = rest.join(": ");
              const canEdit = isAdmin || user === currentUser;
              return `<div class='note'><span>${note}</span> ${canEdit ? `<button onclick=\"addNote('${doc.id}','${content.replace(/"/g, '&quot;')}')\">✏️</button>` : ''}</div>`;
            }).join('')}
            <div style="margin-top:1rem">
              <button onclick="addNote('${doc.id}')">💬 رد</button>
              ${isAdmin ? `
                <button onclick='archiveTask("${doc.id}", ${JSON.stringify(t).replace(/"/g, '&quot;')})'>📁 تم الإنجاز</button>
                <button onclick='deleteTask("${doc.id}")'>🗑️ حذف</button>` : ''}
            </div>
          `;
          box.appendChild(div);
        });
        document.getElementById('statsText').textContent = `📌 ${notDone} غير منجزة | ✅ ${done} منجزة`;
      });
    }
  </script>
</body>
</html>
